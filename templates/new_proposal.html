<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>PropoFlow • Novo orçamento</title>
  <link rel="stylesheet" href="/static/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<div class="container">
  <div class="nav">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>PropoFlow</h1>
        <p>Novo orçamento (simples e rápido)</p>
      </div>
    </div>
    <div class="actions">
      <a class="btn btn-ghost" href="/dashboard">← Voltar</a>
    </div>
  </div>

  <div class="card">
    <h2 class="h2">Criar orçamento</h2>
    <p class="small">Preencha o básico. O sistema calcula total e já deixa pronto pra enviar no WhatsApp.</p>

    {% if error %}
      <div class="error">{{ error }}</div>
    {% endif %}


    <label>Modelo de serviço (opcional)</label>
<select name="tpl" id="tplSelect" style="width:100%; padding:11px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.22); color:#e8eefc;">
  <option value="">Escolher modelo...</option>
  {% for t in template_list %}
    <option value="{{ t.key }}" {% if tpl == t.key %}selected{% endif %}>{{ t.label }}</option>
  {% endfor %}
</select>
<div style="height:12px;"></div>

<script>
  document.getElementById('tplSelect').addEventListener('change', function(){
    const v = this.value;
    if(!v) return;
    window.location.href = '/proposals/new?tpl=' + encodeURIComponent(v);
  });
</script>


    <form method="post" action="/proposals/new" id="formOrc">
      <div class="row">
        <div>
          <label>Nome do cliente</label>
          <input name="client_name" required placeholder="Ex: Maria Silva">
        </div>
        <div>
          <label>WhatsApp do cliente (pra enviar)</label>
          <input name="client_whatsapp" placeholder="Ex: (11) 99999-9999">
        </div>
      </div>

      <br>

      <div class="row">
        <div>
          <label>Serviço / Projeto</label>
          <input name="project_name" required placeholder="Ex: Troca de tomada / Pintura do quarto">
        </div>
        <div>
          <label>Prazo</label>
          <input name="deadline" required placeholder="Ex: 1 dia / 7 dias úteis">
        </div>
      </div>

      <br>

      <div class="row">
        <div>
          <label>Validade do orçamento (dias)</label>
          <input name="validity_days" type="number" min="1" max="30" value="7" required>
        </div>
        <div>
          <label>Total final (se você já sabe) — opcional</label>
          <input name="price" placeholder="Ex: R$ 250,00">
        </div>
      </div>

      <br>

      <label>O que será feito</label>
      <textarea name="description" required placeholder="Escreva do jeito que você falaria:
Ex: Vou trocar a tomada, testar e deixar funcionando."></textarea>

      <br><br>

      <h3 class="h2" style="font-size:15px;">Itens (opcional)</h3>
      <p class="small" style="margin-top:0;">
        Se quiser, preencha itens. Se não quiser, pode deixar vazio e colocar só o “Total final”.
      </p>

      <div class="table-wrap">
        <table class="table" id="itemsTable" style="min-width: 680px;">
          <tr>
            <th>Item</th>
            <th>Quantidade</th>
            <th>Valor (R$)</th>
            <th>Total</th>
          </tr>

          {% for i in range(0,5) %}
          <tr>
            <td><input name="item_desc" placeholder="Ex: Tomada / Mão de obra" /></td>
            <td><input name="item_qty" placeholder="1" /></td>
            <td><input name="item_unit_price" placeholder="25" /></td>
            <td style="font-weight:800;" class="lineTotal">R$ 0,00</td>

            <!-- campo escondido pra manter compatibilidade do backend -->
            <input type="hidden" name="item_unit" value="un">
          </tr>
          {% endfor %}
        </table>
      </div>

      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <button class="btn btn-ghost" type="button" onclick="addRow()">+ Adicionar item</button>
        <span class="pill">Total estimado: <b id="totalEstimado" style="color: rgba(232,238,252,0.95);">R$ 0,00</b></span>
      </div>

      <br>

      <h3 class="h2" style="font-size:15px;">Como será o pagamento</h3>
      <p class="small" style="margin-top:0;">Escolha um modelo simples. (Você pode mudar depois.)</p>

      <label>Forma de pagamento</label>
      <select name="payment_plan" id="paymentPlan" style="width:100%; padding:11px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.22); color: #e8eefc;">
        <option value="avista">À vista (100%)</option>
        <option value="entrada_final_30" selected>Entrada + na entrega (30% / 70%)</option>
        <option value="entrada_final_50">Entrada + na entrega (50% / 50%)</option>
        <option value="3x_30_40_30">Entrada + durante + na entrega (30% / 40% / 30%)</option>
        <option value="personalizado">Personalizado (avançado)</option>
      </select>

      <div id="customPay" style="display:none; margin-top:12px;">
        <div class="row">
          <div>
            <label>Entrada (%)</label>
            <input name="p1_percent" type="number" min="0" max="100" value="30">
          </div>
          <div>
            <label>Durante o serviço (%)</label>
            <input name="p2_percent" type="number" min="0" max="100" value="40">
          </div>
        </div>
        <br>
        <div class="row">
          <div>
            <label>Na entrega (%)</label>
            <input name="p3_percent" type="number" min="0" max="100" value="30">
          </div>
          <div></div>
        </div>
      </div>

      <details style="margin-top:14px;">
        <summary class="small" style="cursor:pointer;">Opções avançadas (opcional)</summary>
        <div style="margin-top:10px;">
          <div class="row">
            <div>
              <label>Reserva (opcional) — % para cobrir gastos que aparecem</label>
              <input name="reserve_percent" type="number" min="0" max="50" value="0" placeholder="Ex: 10">
              <p class="small" style="margin:8px 0 0; opacity:.8;">Se você costuma ter “coisinhas a mais”, coloque 5% ou 10%.</p>
            </div>
            <div>
              <label>Lucro extra (opcional) — % além do valor dos itens</label>
              <input name="profit_percent" type="number" min="0" max="80" value="0" placeholder="Ex: 20">
              <p class="small" style="margin:8px 0 0; opacity:.8;">Se você quer ganhar acima do custo, coloque aqui.</p>
            </div>
          </div>
        </div>
      </details>

      <br><br>

      <button class="btn" type="submit">Criar orçamento</button>
    </form>
  </div>
</div>

<script>
  function brl(n){
    try{
      const v = (Math.round(n*100)/100).toFixed(2).replace('.', ',');
      return 'R$ ' + v;
    }catch(e){ return 'R$ 0,00'; }
  }

  function parseNum(v){
    if(!v) return 0;
    v = (''+v).replace(/\./g,'').replace(',', '.');
    const n = parseFloat(v);
    return isNaN(n) ? 0 : n;
  }

  function recalc(){
    const rows = document.querySelectorAll('#itemsTable tr');
    let total = 0;

    rows.forEach((tr, idx) => {
      if(idx === 0) return; // header
      const inputs = tr.querySelectorAll('input');
      if(inputs.length < 3) return;

      const desc = inputs[0].value.trim();
      const qty = parseNum(inputs[1].value) || 0;
      const unit = parseNum(inputs[2].value) || 0;

      let line = 0;
      if(desc && qty > 0 && unit > 0){
        line = qty * unit;
      }

      const td = tr.querySelector('.lineTotal');
      if(td) td.textContent = brl(line);

      total += line;
    });

    document.getElementById('totalEstimado').textContent = brl(total);
  }

  function addRow(){
    const table = document.getElementById("itemsTable");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input name="item_desc" placeholder="Ex: Serviço..." /></td>
      <td><input name="item_qty" placeholder="1" /></td>
      <td><input name="item_unit_price" placeholder="100" /></td>
      <td style="font-weight:800;" class="lineTotal">R$ 0,00</td>
      <input type="hidden" name="item_unit" value="un">
    `;
    table.appendChild(tr);
  }

  document.addEventListener('input', (e) => {
    if(e.target && (e.target.name === 'item_desc' || e.target.name === 'item_qty' || e.target.name === 'item_unit_price')){
      recalc();
    }
  });

  const plan = document.getElementById('paymentPlan');
  const custom = document.getElementById('customPay');
  plan.addEventListener('change', () => {
    custom.style.display = (plan.value === 'personalizado') ? 'block' : 'none';
  });

  recalc();
</script>
</body>
</html>