<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>PropoFlow • Novo orçamento</title>
  <link rel="stylesheet" href="/static/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<div class="container">
  <div class="nav">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>PropoFlow</h1>
        <p>Novo orçamento (simples)</p>
      </div>
    </div>
    <div class="actions">
      <a class="btn btn-ghost" href="/dashboard">← Voltar</a>
      <a class="btn btn-ghost" href="/services">Meus serviços</a>
    </div>
  </div>

  <div class="card">
    <h2 class="h2">Criar orçamento</h2>
    <p class="small">Se você escolher um serviço salvo, o orçamento já vem preenchido.</p>

    {% if error %}
      <div class="error">{{ error }}</div>
    {% endif %}

    <form method="post" action="/proposals/new" id="formOrc">
      <label>Serviço salvo (opcional)</label>
      <select name="service_id" id="serviceSelect" style="width:100%; padding:11px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.22); color:#e8eefc;">
        <option value="0">Escolher...</option>
        {% for s in services %}
          <option value="{{ s.id }}" {% if selected_service_id == s.id %}selected{% endif %}>{{ s.title }}</option>
        {% endfor %}
      </select>

      <div style="height:12px;"></div>
<label>Cliente salvo (opcional)</label>
<select name="client_id" id="clientSelect" style="width:100%; padding:11px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.22); color:#e8eefc;">
  <option value="0">Escolher...</option>
  {% for c in clients %}
    <option value="{{ c.id }}" {% if selected_client_id == c.id %}selected{% endif %}>{{ c.name }}</option>
  {% endfor %}
</select>
<div style="height:12px;"></div>

<script>
document.getElementById('clientSelect').addEventListener('change', function(){
  const id = this.value;
  const url = new URL(window.location.href);
  if(id && id !== "0") url.searchParams.set('client_id', id);
  else url.searchParams.delete('client_id');
  window.location.href = url.toString();
});
</script>
      <div class="row">
        <div>
          <label>Nome do cliente</label>
          <input name="client_name" required placeholder="Ex: Maria Silva">
        </div>
        <div>
          <label>WhatsApp do cliente (opcional)</label>
          <input name="client_whatsapp" placeholder="Ex: (11) 99999-9999">
        </div>
      </div>

      <br>

      <div class="row">
        <div>
          <label>Serviço / Projeto</label>
          <input name="project_name" required value="{{ prefill.project_name or '' }}" placeholder="Ex: Limpeza de sofá">
        </div>
        <div>
          <label>Prazo</label>
          <input name="deadline" required value="{{ prefill.deadline or '' }}" placeholder="Ex: 1 dia / 2 dias">
        </div>
      </div>

      <br>

      <div class="row">
        <div>
          <label>Validade do orçamento (dias)</label>
          <input name="validity_days" type="number" min="1" max="30" value="7" required>
        </div>
        <div>
          <label>Valor total (opcional — se já sabe)</label>
          <input name="price" value="{{ prefill.price or '' }}" placeholder="Ex: R$ 250,00">
        </div>
      </div>

      <br>

      <label>O que será feito</label>
      <textarea name="description" required placeholder="Escreva do jeito que você falaria.">{{ prefill.description or '' }}</textarea>

      <br><br>

      <h3 class="h2" style="font-size:15px;">Itens (opcional)</h3>
      <p class="small" style="margin-top:0;">Se não quiser itens, deixe vazio e use só “Valor total”.</p>

      <div class="table-wrap">
        <table class="table" id="itemsTable" style="min-width: 680px;">
          <tr>
            <th>Item</th>
            <th>Quantidade</th>
            <th>Valor (R$)</th>
            <th>Total</th>
          </tr>

          {% for i in range(0,5) %}
          <tr>
            <td><input name="item_desc" placeholder="Ex: Serviço..." /></td>
            <td><input name="item_qty" placeholder="1" /></td>
            <td><input name="item_unit_price" placeholder="100" /></td>
            <td style="font-weight:800;" class="lineTotal">R$ 0,00</td>
            <input type="hidden" name="item_unit" value="un">
          </tr>
          {% endfor %}
        </table>
      </div>

      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <button class="btn btn-ghost" type="button" onclick="addRow()">+ Adicionar item</button>
        <span class="pill">Total estimado: <b id="totalEstimado" style="color: rgba(232,238,252,0.95);">R$ 0,00</b></span>
      </div>

      <br>

      <h3 class="h2" style="font-size:15px;">Como pagar (opcional)</h3>
      <select name="payment_plan" style="width:100%; padding:11px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.22); color:#e8eefc;">
        <option value="avista" {% if prefill.payment_plan=='avista' %}selected{% endif %}>À vista</option>
        <option value="entrada_final_30" {% if prefill.payment_plan=='entrada_final_30' %}selected{% endif %}>Entrada + na entrega (30/70)</option>
        <option value="entrada_final_50" {% if prefill.payment_plan=='entrada_final_50' %}selected{% endif %}>Entrada + na entrega (50/50)</option>
        <option value="3x_30_40_30" {% if prefill.payment_plan=='3x_30_40_30' %}selected{% endif %}>Entrada + durante + na entrega (30/40/30)</option>
      </select>

      <div style="height:16px;"></div>
      <button class="btn" type="submit">Criar orçamento</button>
    </form>
  </div>
</div>

<script>
  function brl(n){
    try{
      const v = (Math.round(n*100)/100).toFixed(2).replace('.', ',');
      return 'R$ ' + v;
    }catch(e){ return 'R$ 0,00'; }
  }
  function parseNum(v){
    if(!v) return 0;
    v = (''+v).replace(/\./g,'').replace(',', '.');
    const n = parseFloat(v);
    return isNaN(n) ? 0 : n;
  }
  function recalc(){
    const rows = document.querySelectorAll('#itemsTable tr');
    let total = 0;
    rows.forEach((tr, idx) => {
      if(idx === 0) return;
      const inputs = tr.querySelectorAll('input');
      if(inputs.length < 3) return;
      const desc = inputs[0].value.trim();
      const qty = parseNum(inputs[1].value) || 0;
      const unit = parseNum(inputs[2].value) || 0;
      let line = 0;
      if(desc && qty > 0 && unit > 0) line = qty * unit;
      const td = tr.querySelector('.lineTotal');
      if(td) td.textContent = brl(line);
      total += line;
    });
    document.getElementById('totalEstimado').textContent = brl(total);
  }
  function addRow(){
    const table = document.getElementById("itemsTable");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input name="item_desc" placeholder="Ex: Serviço..." /></td>
      <td><input name="item_qty" placeholder="1" /></td>
      <td><input name="item_unit_price" placeholder="100" /></td>
      <td style="font-weight:800;" class="lineTotal">R$ 0,00</td>
      <input type="hidden" name="item_unit" value="un">
    `;
    table.appendChild(tr);
  }

  document.addEventListener('input', (e) => {
    if(e.target && (e.target.name === 'item_desc' || e.target.name === 'item_qty' || e.target.name === 'item_unit_price')){
      recalc();
    }
  });

  document.getElementById('serviceSelect').addEventListener('change', function(){
    const id = this.value;
    const url = new URL(window.location.href);
    if(id && id !== "0") url.searchParams.set('service_id', id);
    else url.searchParams.delete('service_id');
    window.location.href = url.toString();
  });

  recalc();
</script>
</body>
</html>