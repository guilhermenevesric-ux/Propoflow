<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>PropoFlow â€¢ Dashboard</title>
  <link rel="stylesheet" href="/static/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <div class="container">
    <div class="nav">
      <div class="brand">
        <div class="logo"></div>
        <div>
          {% if owner and owner.company_name %}
            <h1>{{ owner.company_name }}</h1>
            <p>
              {% if owner.display_name %}{{ owner.display_name }}{% endif %}
              {% if owner.phone %} â€¢ {{ owner.phone }}{% endif %}
            </p>
          {% else %}
            <h1>PropoFlow</h1>
            <p>
              {% if owner and owner.display_name %}{{ owner.display_name }}{% else %}OrÃ§amentos profissionais{% endif %}
              {% if owner and owner.phone %} â€¢ {{ owner.phone }}{% endif %}
            </p>
          {% endif %}
        </div>
      </div>

      <div class="actions">
        <a class="btn btn-ghost" href="/wizard">Assistente</a>
        <a class="btn btn-ghost" href="/services">Meus serviÃ§os</a>
        <a class="btn btn-ghost" href="/clients">Clientes</a>
        <a class="btn btn-ghost" href="/settings">PadrÃµes</a>

        <a class="btn btn-ghost" href="/profile">Perfil</a>
        <a class="btn btn-ghost" href="/billing">Assinatura</a>

        {% if user and user.plan == "pro" %}
          <span class="pill">âœ¨ PRO</span>
        {% else %}
          <a class="btn" href="/pricing">Upgrade</a>
        {% endif %}

        <a class="btn" href="/wizard">+ Novo orÃ§amento</a>
        <a class="btn btn-ghost" href="/logout">Sair</a>
      </div>
    </div>

    <div class="card">
      <h2 class="h2">Seus orÃ§amentos</h2>
      <p class="small">Crie, envie e acompanhe em link pÃºblico e PDF.</p>

      {% if error %}
        <div class="error">
          {{ error }}
          {% if show_upgrade %}
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
              <a class="btn" href="/pricing">Upgrade</a>
              <a class="btn btn-ghost" href="/pricing">Ver planos</a>
            </div>
          {% endif %}
        </div>
      {% endif %}

      <!-- KPIs -->
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin: 12px 0 12px;">
        <span class="pill">ðŸ“„ Total: <b style="color: rgba(232,238,252,0.95);">{{ total }}</b></span>
        <span class="pill">âœ… Aceitos: <b style="color: rgba(232,238,252,0.95);">{{ accepted }}</b></span>
        <span class="pill">ðŸ“ˆ ConversÃ£o: <b style="color: rgba(232,238,252,0.95);">{{ rate }}%</b></span>
        <span class="pill">ðŸ‘€ Vistos: <b style="color: rgba(232,238,252,0.95);">{{ viewed }}</b></span>
      </div>

      <!-- Filtros de status -->
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin: 0 0 14px;">
        <a class="btn btn-ghost" href="/dashboard?status=all&days={{ days or 30 }}"
           style="{% if status == 'all' %}border-color: rgba(79,124,255,0.8);{% endif %}">
          Todas
        </a>

        <a class="btn btn-ghost" href="/dashboard?status=pending&days={{ days or 30 }}"
           style="{% if status == 'pending' %}border-color: rgba(79,124,255,0.8);{% endif %}">
          Pendentes
        </a>

        <a class="btn btn-ghost" href="/dashboard?status=accepted&days={{ days or 30 }}"
           style="{% if status == 'accepted' %}border-color: rgba(79,124,255,0.8);{% endif %}">
          Aceitos
        </a>
      </div>

      <!-- Busca + perÃ­odo -->
      <form method="get" action="/dashboard" class="card" style="padding:14px; margin: 0 0 14px;">
        <div class="row">
          <div>
            <label>Buscar</label>
            <input name="q" value="{{ q or '' }}" placeholder="Cliente, serviÃ§o ou ID">
          </div>
          <div>
            <label>PerÃ­odo</label>
            <select name="days" style="width:100%; padding:11px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.22); color:#e8eefc;">
              <option value="7" {% if days==7 %}selected{% endif %}>Ãšltimos 7 dias</option>
              <option value="30" {% if days==30 or not days %}selected{% endif %}>Ãšltimos 30 dias</option>
              <option value="90" {% if days==90 %}selected{% endif %}>Ãšltimos 90 dias</option>
            </select>
          </div>
        </div>

        <input type="hidden" name="status" value="{{ status or 'all' }}">

        <div style="height:12px;"></div>
        <div class="actions">
          <button class="btn" type="submit">Aplicar</button>
          {% if q %}
            <a class="btn btn-ghost" href="/dashboard?status={{ status or 'all' }}&days={{ days or 30 }}">Limpar</a>
          {% endif %}
        </div>
      </form>

      {% if proposals|length == 0 %}
        <p class="small">
          Nenhum orÃ§amento encontrado neste filtro.
          <a href="/wizard">Criar novo</a>.
        </p>
      {% else %}

        <!-- Mobile cards -->
        <div class="mobile-list">
          {% for p in proposals %}
            <div class="card proposal-card">
              <p class="title">{{ p.project_name }}</p>
              <p class="meta">
                Cliente: <b>{{ p.client_name }}</b><br>
                {{ p.created_at.strftime("%d/%m/%Y %H:%M") }}
              </p>

              <p class="small" style="margin-top:0;">
                Status:
                <td>
  {% if p.accepted_at %}
    <span style="color:#22c55e; font-weight:800;">âœ“ ACEITO</span>
    <div class="small" style="opacity:.85;">{{ p.accepted_at.strftime("%d/%m/%Y") }}</div>
  {% elif p.last_viewed_at %}
    <span style="color:#60a5fa; font-weight:800;">ðŸ‘€ VISTO</span>
    <div class="small" style="opacity:.85;">{{ p.last_viewed_at.strftime("%d/%m/%Y %H:%M") }}</div>
    <div class="small" style="opacity:.75;">{{ p.view_count or 0 }}x</div>
  {% else %}
    <span class="small">NÃ£o visto</span>
  {% endif %}
</td>
              </p>

              <div class="actions">
                <a class="btn" href="/p/{{ p.public_id }}">Abrir link</a>
                <a class="btn btn-ghost" href="/proposals/{{ p.id }}/pdf">PDF</a>
                <a class="btn btn-ghost" href="/proposals/{{ p.id }}/again">Novo igual</a>
                <a class="btn btn-ghost" href="/proposals/{{ p.id }}/edit">Editar</a>
                <a class="btn btn-ghost" href="/proposals/{{ p.id }}/duplicate">Duplicar</a>

                <form method="post" action="/proposals/{{ p.id }}/delete"
                      onsubmit="return confirm('Tem certeza que deseja excluir este orÃ§amento?');">
                  <button class="btn btn-ghost" type="submit">Excluir</button>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- Desktop table -->
        <div class="table-wrap">
          <table class="table">
            <tr>
              <th>Data</th>
              <th>Cliente</th>
              <th>ServiÃ§o</th>
              <th>Status</th>
              <th>AÃ§Ãµes</th>
            </tr>

            {% for p in proposals %}
            <tr>
              <td>{{ p.created_at.strftime("%d/%m/%Y %H:%M") }}</td>
              <td>{{ p.client_name }}</td>
              <td>{{ p.project_name }}</td>

              <p class="small" style="margin-top:0;">
  Status:
  {% if p.accepted_at %}
    <span style="color:#22c55e; font-weight:800;">âœ“ ACEITO</span>
    <span class="small" style="opacity:.85;"> â€¢ {{ p.accepted_at.strftime("%d/%m/%Y") }}</span>
  {% elif p.last_viewed_at %}
    <span style="color:#60a5fa; font-weight:800;">ðŸ‘€ VISTO</span>
    <span class="small" style="opacity:.85;"> â€¢ {{ p.last_viewed_at.strftime("%d/%m/%Y %H:%M") }} ({{ p.view_count or 0 }}x)</span>
  {% else %}
    <span class="small">NÃ£o visto</span>
  {% endif %}
</p>

              <td>
                <a class="btn" href="/p/{{ p.public_id }}">Abrir</a>
                <a class="btn btn-ghost" href="/proposals/{{ p.id }}/pdf">PDF</a>
                <a class="btn btn-ghost" href="/proposals/{{ p.id }}/again">Novo igual</a>
                <a class="btn btn-ghost" href="/proposals/{{ p.id }}/edit">Editar</a>
                <a class="btn btn-ghost" href="/proposals/{{ p.id }}/duplicate">Duplicar</a>

                <form method="post" action="/proposals/{{ p.id }}/delete" style="display:inline;"
                      onsubmit="return confirm('Tem certeza que deseja excluir este orÃ§amento?');">
                  <button class="btn btn-ghost" type="submit">Excluir</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </table>
        </div>

      {% endif %}
    </div>

    <p class="small" style="margin-top:18px; opacity:.6; text-align:center;">
      <a href="/terms">Termos</a> â€¢ <a href="/privacy">Privacidade</a> â€¢ <a href="/support">Suporte</a>
    </p>
  </div>
</body>
</html>