<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>PropoFlow â€¢ Dashboard</title>
  <link rel="stylesheet" href="/static/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <div class="container">

    <!-- TOPBAR (simples) -->
    <div class="nav">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>
            {% if owner and owner.company_name %}
              {{ owner.company_name }}
            {% else %}
              PropoFlow
            {% endif %}
          </h1>
          <p>
            {% if owner and owner.display_name %}{{ owner.display_name }}{% endif %}
            {% if owner and owner.phone %} â€¢ {{ owner.phone }}{% endif %}
          </p>
        </div>
      </div>

      <div class="actions">
        <a class="btn" href="/wizard">+ Novo orÃ§amento</a>

        {% if user and user.plan != "pro" %}
          <a class="btn btn-ghost" href="/pricing">Upgrade</a>
        {% else %}
          <span class="pill">âœ¨ PRO</span>
        {% endif %}

        <!-- Menu compacto -->
        <details class="menu">
          <summary class="btn btn-ghost icon-btn" title="Menu">â˜°</summary>
          <div class="menu-panel">
            <a href="/wizard">Assistente</a>
            <a href="/services">Meus serviÃ§os</a>
            <a href="/clients">Clientes</a>
            <a href="/settings">PadrÃµes</a>
            <a href="/profile">Perfil</a>
            <a href="/billing">Assinatura</a>
            <hr style="border:0; border-top:1px solid rgba(255,255,255,0.12); margin:8px 0;">
            <a href="/logout">Sair</a>
          </div>
        </details>
      </div>
    </div>

    <div class="card">
      <h2 class="h2">OrÃ§amentos</h2>
      <p class="small">Crie, envie e acompanhe em link pÃºblico e PDF.</p>

      {% if error %}
        <div class="error">
          {{ error }}
          {% if show_upgrade %}
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
              <a class="btn" href="/pricing">Upgrade</a>
              <a class="btn btn-ghost" href="/pricing">Ver planos</a>
            </div>
          {% endif %}
        </div>
      {% endif %}

      <!-- KPIs (compacto) -->
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin: 12px 0;">
        <span class="pill">ðŸ“„ Total: <b style="color: rgba(232,238,252,0.95);">{{ total }}</b></span>
        <span class="pill">âœ… Aceitos: <b style="color: rgba(232,238,252,0.95);">{{ accepted }}</b></span>
        <span class="pill">ðŸ‘€ Vistos: <b style="color: rgba(232,238,252,0.95);">{{ viewed }}</b></span>
        <span class="pill">ðŸ“ˆ ConversÃ£o: <b style="color: rgba(232,238,252,0.95);">{{ rate }}%</b></span>
      </div>

      <!-- Filtros -->
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin: 0 0 14px;">
        <a class="btn btn-ghost" href="/dashboard?status=all&days={{ days or 30 }}&q={{ q or '' }}"
           style="{% if status == 'all' %}border-color: rgba(79,124,255,0.8);{% endif %}">
          Todas
        </a>

        <a class="btn btn-ghost" href="/dashboard?status=pending&days={{ days or 30 }}&q={{ q or '' }}"
           style="{% if status == 'pending' %}border-color: rgba(79,124,255,0.8);{% endif %}">
          Pendentes
        </a>

        <a class="btn btn-ghost" href="/dashboard?status=accepted&days={{ days or 30 }}&q={{ q or '' }}"
           style="{% if status == 'accepted' %}border-color: rgba(79,124,255,0.8);{% endif %}">
          Aceitos
        </a>
      </div>

      <!-- Busca + perÃ­odo -->
      <form method="get" action="/dashboard" class="card" style="padding:14px; margin: 0 0 14px;">
        <div class="row">
          <div>
            <label>Buscar</label>
            <input name="q" value="{{ q or '' }}" placeholder="Cliente, serviÃ§o ou ID">
          </div>
          <div>
            <label>PerÃ­odo</label>
            <select name="days" style="width:100%; padding:11px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.22); color:#e8eefc;">
              <option value="7" {% if days==7 %}selected{% endif %}>Ãšltimos 7 dias</option>
              <option value="30" {% if days==30 or not days %}selected{% endif %}>Ãšltimos 30 dias</option>
              <option value="90" {% if days==90 %}selected{% endif %}>Ãšltimos 90 dias</option>
            </select>
          </div>
        </div>

        <input type="hidden" name="status" value="{{ status or 'all' }}">

        <div style="height:12px;"></div>
        <div class="actions">
          <button class="btn" type="submit">Aplicar</button>
          {% if q %}
            <a class="btn btn-ghost" href="/dashboard?status={{ status or 'all' }}&days={{ days or 30 }}">Limpar</a>
          {% endif %}
        </div>
      </form>

      {% if proposals|length == 0 %}
        <p class="small">
          Nenhum orÃ§amento encontrado.
          <a href="/wizard">Criar novo</a>.
        </p>
      {% else %}

        <!-- MOBILE -->
        <div class="mobile-list">
          {% for p in proposals %}
            <div class="card proposal-card">
              <p class="title">{{ p.project_name }}</p>
              <p class="meta">
                Cliente: <b>{{ p.client_name }}</b><br>
                {{ p.created_at.strftime("%d/%m/%Y %H:%M") }}
              </p>

              <p class="small" style="margin-top:0;">
                {% if p.accepted_at %}
                  <span class="status-pill ok">âœ“ Aceito</span>
                  <span class="small" style="opacity:.85;"> â€¢ {{ p.accepted_at.strftime("%d/%m %H:%M") }}</span>
                {% elif p.last_viewed_at %}
                  <span class="status-pill seen">ðŸ‘€ Visto</span>
                  <span class="small" style="opacity:.85;">
                    â€¢ {{ p.last_viewed_at.strftime("%d/%m %H:%M") }} â€¢ {{ p.view_count or 0 }}x
                  </span>
                {% else %}
                  <span class="status-pill none">NÃ£o visto</span>
                {% endif %}
              </p>

              <div class="actions">
                <a class="btn" href="/p/{{ p.public_id }}">Abrir</a>
                <a class="btn btn-ghost" href="/proposals/{{ p.id }}/pdf">PDF</a>

                <details class="menu">
                  <summary class="btn btn-ghost icon-btn">â‹¯</summary>
                  <div class="menu-panel">
                    <a href="/proposals/{{ p.id }}/again">Novo igual</a>
                    <a href="/proposals/{{ p.id }}/edit">Editar</a>
                    <a href="/proposals/{{ p.id }}/duplicate">Duplicar</a>
                    <form method="post" action="/proposals/{{ p.id }}/delete"
                          onsubmit="return confirm('Tem certeza que deseja excluir este orÃ§amento?');">
                      <button type="submit">Excluir</button>
                    </form>
                  </div>
                </details>
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- DESKTOP -->
        <div class="table-wrap">
          <table class="table">
            <tr>
              <th>Data</th>
              <th>Cliente</th>
              <th>ServiÃ§o</th>
              <th>Status</th>
              <th>AÃ§Ãµes</th>
            </tr>

            {% for p in proposals %}
            <tr>
              <td>{{ p.created_at.strftime("%d/%m/%Y %H:%M") }}</td>
              <td>{{ p.client_name }}</td>
              <td>{{ p.project_name }}</td>

              <td>
                {% if p.accepted_at %}
                  <span class="status-pill ok">âœ“ Aceito</span>
                  <span class="small" style="opacity:.85;"> â€¢ {{ p.accepted_at.strftime("%d/%m %H:%M") }}</span>
                {% elif p.last_viewed_at %}
                  <span class="status-pill seen">ðŸ‘€ Visto</span>
                  <span class="small" style="opacity:.85;">
                    â€¢ {{ p.last_viewed_at.strftime("%d/%m %H:%M") }} â€¢ {{ p.view_count or 0 }}x
                  </span>
                {% else %}
                  <span class="status-pill none">NÃ£o visto</span>
                {% endif %}
              </td>

              <td>
                <div class="actions">
                  <a class="btn" href="/p/{{ p.public_id }}">Abrir</a>
                  <a class="btn btn-ghost" href="/proposals/{{ p.id }}/pdf">PDF</a>

                  <details class="menu">
                    <summary class="btn btn-ghost icon-btn">â‹¯</summary>
                    <div class="menu-panel">
                      <a href="/proposals/{{ p.id }}/again">Novo igual</a>
                      <a href="/proposals/{{ p.id }}/edit">Editar</a>
                      <a href="/proposals/{{ p.id }}/duplicate">Duplicar</a>
                      <form method="post" action="/proposals/{{ p.id }}/delete"
                            onsubmit="return confirm('Tem certeza que deseja excluir este orÃ§amento?');">
                        <button type="submit">Excluir</button>
                      </form>
                    </div>
                  </details>
                </div>
              </td>
            </tr>
            {% endfor %}
          </table>
        </div>

      {% endif %}
    </div>

    <p class="small" style="margin-top:18px; opacity:.6; text-align:center;">
      <a href="/terms">Termos</a> â€¢ <a href="/privacy">Privacidade</a> â€¢ <a href="/support">Suporte</a>
    </p>
  </div>
</body>
</html>