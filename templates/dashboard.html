<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>PropoFlow â€¢ Dashboard</title>
  <link rel="stylesheet" href="/static/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<div class="container">
  <div class="nav">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>{{ owner.company_name or (owner.display_name or "PropoFlow") }}</h1>
        <p>
          {% if owner.display_name %}{{ owner.display_name }}{% endif %}
          {% if owner.phone %} â€¢ {{ owner.phone }}{% endif %}
        </p>
      </div>
    </div>

    <div class="actions">
      <a class="btn btn-ghost" href="/profile">Perfil</a>
      <a class="btn btn-ghost" href="/billing">Assinatura</a>
      <a class="btn btn-ghost" href="/services">Meus serviÃ§os</a>

      {% if user and user.plan == "pro" %}
        <span class="pill">âœ¨ PRO</span>
      {% else %}
        <a class="btn" href="/pricing">Upgrade</a>
      {% endif %}

      <a class="btn" href="/proposals/new">+ Novo orÃ§amento</a>
      <a class="btn btn-ghost" href="/logout">Sair</a>
    </div>
  </div>

  {% if due_payment_reminders and due_payment_reminders|length > 0 %}
    <div class="card" style="margin-bottom:14px;">
      <h2 class="h2">ðŸ’° CobranÃ§as de sinal (hoje)</h2>
      <p class="small">Clique e mande no WhatsApp (Pix + valor + texto humano).</p>

      <div style="display:grid; gap:10px;">
        {% for r in due_payment_reminders %}
          <div class="card" style="padding:14px;">
            <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <div>
                <div style="font-weight:900; font-size:16px;">{{ r.stage.proposal.project_name }}</div>
                <div class="small" style="margin:6px 0 0;">
                  Cliente: <b>{{ r.stage.proposal.client_name }}</b>
                  â€¢ {{ r.stage.title }}: <b>R$ {{ ('%.2f'|format((r.stage.amount_cents or 0)/100)).replace('.', ',') }}</b>
                </div>
              </div>
              <div class="actions">
                <a class="btn" href="/payments/reminders/{{ r.id }}/send_whatsapp">Enviar Pix</a>
                <form method="post" action="/payments/stages/{{ r.stage.id }}/mark_paid" style="display:inline;">
                  <button class="btn btn-ghost" type="submit">Marcar pago</button>
                </form>
                <a class="btn btn-ghost" href="/p/{{ r.stage.proposal.public_id }}">Abrir link</a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {% if due_followups and due_followups|length > 0 %}
    <div class="card" style="margin-bottom:14px;">
      <h2 class="h2">ðŸ”¥ Follow-ups de hoje</h2>
      <p class="small">Clique e envie no WhatsApp (mensagem pronta).</p>

      <div style="display:grid; gap:10px;">
        {% for f in due_followups %}
          <div class="card" style="padding:14px;">
            <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <div>
                <div style="font-weight:900; font-size:16px;">{{ f.proposal.project_name }}</div>
                <div class="small" style="margin:6px 0 0;">
                  Cliente: <b>{{ f.proposal.client_name }}</b> â€¢ D+{{ f.step }} â€¢ Visto: {{ f.proposal.view_count or 0 }}x
                </div>
              </div>
              <div class="actions">
                <a class="btn" href="/proposals/{{ f.proposal.id }}/followup/{{ f.step }}">Enviar follow-up</a>
                <a class="btn btn-ghost" href="/p/{{ f.proposal.public_id }}">Abrir link</a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <div class="card">
    <h2 class="h2">Seus orÃ§amentos</h2>
    <p class="small">Agora tem itens + total + etapas + cobranÃ§a de sinal + versÃ£o.</p>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin: 12px 0 12px;">
      <span class="pill">ðŸ“„ Total: <b style="color: rgba(232,238,252,0.95);">{{ total }}</b></span>
      <span class="pill">âœ… Aceitos: <b style="color: rgba(232,238,252,0.95);">{{ accepted }}</b></span>
      <span class="pill">ðŸ“ˆ ConversÃ£o: <b style="color: rgba(232,238,252,0.95);">{{ rate }}%</b></span>
      <span class="pill">ðŸ’° CobranÃ§as hoje: <b style="color: rgba(232,238,252,0.95);">{{ due_payment_reminders|length }}</b></span>
      <span class="pill">ðŸ”¥ Follow-ups hoje: <b style="color: rgba(232,238,252,0.95);">{{ due_followups|length }}</b></span>
    </div>

    <div class="table-wrap">
      <table class="table">
        <tr>
          <th>Data</th>
          <th>Cliente</th>
          <th>Projeto</th>
          <th>Status</th>
          <th>Total</th>
          <th>AÃ§Ãµes</th>
        </tr>

        {% for p in proposals %}
        <tr>
          <td>{{ p.created_at.strftime("%d/%m/%Y %H:%M") }}</td>
          <td>
            {{ p.client_name }}
            {% if p.client_whatsapp %}
              <div class="small" style="opacity:.8;">{{ p.client_whatsapp }}</div>
            {% endif %}
          </td>
          <td>
            {{ p.project_name }}
            <div class="small" style="opacity:.8;">v{{ p.revision }}</div>
          </td>
          <td>
            {% if p.accepted_at %}
              <span style="color:#22c55e; font-weight:800;">âœ“ Aceito</span>
            {% else %}
              <span class="pill" style="padding:6px 10px;">{{ status_label(p.status) }}</span>
            {% endif %}
            {% if p.valid_until %}
              <div class="small" style="opacity:.8;">VÃ¡lido atÃ© {{ p.valid_until.strftime("%d/%m") }}</div>
            {% endif %}
          </td>
          <td>
            <b>R$ {{ ('%.2f'|format((p.total_cents or 0)/100)).replace('.', ',') }}</b>
          </td>
          <td>
            <a class="btn btn-ghost" href="/p/{{ p.public_id }}">Abrir</a>
            <a class="btn btn-ghost" href="/proposals/{{ p.id }}/pdf">PDF</a>
            <a class="btn btn-ghost" href="/proposals/{{ p.id }}/edit">Editar</a>
            {% if not p.accepted_at %}
              <a class="btn" href="/proposals/{{ p.id }}/send_whatsapp">Enviar WhatsApp</a>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </table>
    </div>
  </div>
</div>
</body>
</html>